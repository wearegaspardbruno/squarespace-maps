/*!
 * Squarespace Maps plugin v0.0.2 (https://github.com/vascogaspar/bootstrap-extra-modal.git)
 * Copyright 2016, Vasco Gaspar, for Gaspard+Bruno (http://gaspardbruno.com/)
 * Portfolio at https://vasco.work
 * Licensed under the ISC license
 */
!function(a){a.fn.squarespaceMap=function(b){var c,d,e,f=a.extend({storesURL:"/stores",storeSelector:".eventlist-meta-address-maplink",zoom:15,squarespaceContainer:"#main",locatedMessage:"You are here"},b),g=a(this),h=[],i=[],j=function(){if(0!==g.length){c=new google.maps.Map(document.getElementById(g.attr("id")),b),n();var b={zoom:f.zoom};a.ajax({url:f.storesURL,crossDomain:!0,dataType:"html",success:function(b){a(g).after('<div class="debug"></div>');var d=a(".debug");d.hide(),d.html(a(b).filter(f.squarespaceContainer).html());var i=a(".debug .eventlist-meta-address-maplink");e=i.length,i.each(function(b,d){var f=d.href,g=f.match(/q=([^&]*)/);decodeURIComponent(g);a.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="+g[0]+"&sensor=false",null,function(a){var b=a.results[0].geometry.location,d=new google.maps.LatLng(b.lat,b.lng),f=new google.maps.Marker({position:d,map:c});return f.info=new google.maps.InfoWindow({content:a.results[0].formatted_address+' <a href="https://www.google.pt/maps/dir/Current+Location/'+a.results[0].formatted_address+'" target="blank">Get me there</a>'}),google.maps.event.addListener(f,"click",function(){f.info.open(c,f)}),h.push(f),e--,0===e&&k(),f})})}})}},k=function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){var b=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);infowindow=new google.maps.InfoWindow({map:c,position:b,content:f.locatedMessage}),d=b,m(b)},function(){l(!0)}):l(!1),a("#searchMap").show()},l=function(b){var d=new google.maps.LatLngBounds;a.each(h,function(){var a=new google.maps.LatLng(this.position.lat(),this.position.lng());d.extend(a)}),c.fitBounds(d)},m=function(b){var d;if(a.each(h,function(){var a=new google.maps.LatLng(this.position.lat(),this.position.lng()),c=google.maps.geometry.spherical.computeDistanceBetween(a,b);i.push({marker:this,distance:c}),(!d||d.distance>c)&&(d={marker:this,distance:c})}),d){google.maps.event.trigger(d.marker,"click");var e=new google.maps.LatLng(b.lat(),b.lng()),f=new google.maps.LatLng(d.marker.position.lat(),d.marker.position.lng()),g=new google.maps.LatLngBounds;g.extend(e),g.extend(f),c.fitBounds(g)}},n=function(){a(g).before('<input type="text" id="searchMap" placeholder="Search for specific area"/>');var b=document.getElementById("searchMap"),d=new google.maps.places.SearchBox(b);c.addListener("bounds_changed",function(){d.setBounds(c.getBounds())});var e=[];d.addListener("places_changed",function(){var a=d.getPlaces();if(0!==a.length){e.forEach(function(a){a.setMap(null)}),e=[];var b=new google.maps.LatLngBounds;a.forEach(function(a){var d={url:a.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};e.push(new google.maps.Marker({map:c,icon:d,title:a.name,position:a.geometry.location})),a.geometry.viewport?b.union(a.geometry.viewport):b.extend(a.geometry.location)}),c.fitBounds(b)}})};return j()}}(jQuery);